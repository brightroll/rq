#!/bin/sh

PATH=/bin:/usr/bin:/usr/local/bin:/sbin:/usr/sbin:/usr/local/sbin
export PATH

if [ ! -d /rq ] ; then
	# RQ not installed
	exit 0 
fi

me=`id -u`

if [ $me -eq 0 ] ; then
	#TODO this needs to get changed on some hosts as they run as user pr
	#will remove pr dependencies in the future
	exec sudo -u br -i /etc/init.d/rq $*
fi

case $1 in
	start)
		ulimit -c unlimited
		cd /rq/current
		/rq/current/bin/web_server.sh
		/rq/current/bin/queuemgr_ctl start
	;;
	stop)
		cd /rq/current
		/rq/current/bin/queuemgr_ctl stop
		for pid in `ps ax | grep '\[rq' | grep -v grep | awk '{print $1}'`
		do
			kill $pid
		done
		for pid in `ps ax | grep 'web_server' | grep -v grep | awk '{print $1}'`
		do
			kill $pid
		done
	;;
	restart)
		stop
		start
	;;
esac

