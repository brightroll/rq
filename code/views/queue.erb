<% q = params[:name] %>
<h1><a href="<%= url %>">RQ</a> : <a href="<%= "#{url}q/#{q}" %>">Queue [ <%= q %> ]</a> </h1>
<h5><%= RQ::QueueMgrClient.environment %></h5>

<h3>Queue Status</h3>
<ul>
<%  qc = RQ::QueueClient.new(q) %>
<li>
<% if qc.running? %>
<% admin_status, oper_status = qc.status %>
  Admin Status: <span class="<%= admin_status == "UP" ? "green" : "red" %>"> <%= admin_status %></span>
  Oper Status: <span class="<%= oper_status == "UP" ? "green" : "red" %>"> <%= oper_status %></span>
  <span class=""> <%=  qc.ping %></span>
  <span class=""> <%=  qc.read_pid %></span>
  up for <%= qc.uptime %> seconds
<% else %>
  Status: <span class="red">queue is COMPLETELY DOWN</span>
  <br />
<% end %>
</li>
</ul>

<h3>Message List</h3>
  <p><b><a href="<%= "#{url}q/#{q}/new_message" %>">New Message</a></b></p>

<% num_msgs = qc.num_messages %>

<table id="queue_lists">
  <thead>
    <tr>
      <th class="prep"><h4>PREP</h4><%= num_msgs['prep'] %></th>
      <th class="que"><h4>QUE</h4><%= num_msgs['que'] %></th>
      <th class="run"><h4>RUN</h4><%= num_msgs['run'] %></th>
      <% if q != 'relay' %>
        <th class="done"><h4>DONE</h4><%= num_msgs['done'] %></th>
      <% end %>
      <th class="err"><h4>ERR</h4><%= num_msgs['err'] %></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <!-- PREP -->
      <td class="prep">
<ul>
<% msgs = qc.messages({'state' => 'prep', 'limit' => 50}) %>
<% grouped = {} %>
<% msgs.each do |msg| %>
  <% date, rest = msg.split('.', 2) %>
  <% grouped[date] = [] unless grouped[date] %>
  <% grouped[date] << rest %>
<% end %>
<% grouped.sort.reverse.each do |date, msgs| %>
  <h5><%= date %></h5>
  <ul>
  <% msgs.sort.reverse.each do |msg| %>
    <% msg_id = "#{url}q/#{q}/#{msg}" %>
    <li><a href="<%= "#{url}q/#{q}/#{date}.#{msg}" %>"><%= msg %></a></li>
  <% end %>
  </ul>
<% end %>
</ul>
      </td>
      <!-- QUE -->
      <td class="que">
        <ul>
<% msgs = qc.messages({'state' => 'que'}) %>
<% msgs.sort.reverse.each do |msg| %>
<% msg_id = "#{url}q/#{q}/#{msg[0]}" %>
<li>
  <span class="">
    <a href="<%= "#{url}q/#{q}/#{date}.#{msg[0]}" %>"><%= "#{msg[0]}" %></a>
  </span>
  <% if q == 'relay' %>
    <%  ok, msg_full = qc.get_message({ 'msg_id' => msg[0]}) %>
    <% if ok == 'ok' %>
      dest: <span class="yellow"> <%= msg_full['dest'] %></span>
    <% end %>
  <% end %>
  : in <%= msg[1].to_i - Time.now.to_i %> secs</span>
  <span class="">
    <form method="post" action="<%= "#{url}q/#{q}/#{msg[0]}" %>">
    <input name="_method" type="hidden" value="delete" />
    <button type="submit">Destroy it</button>
    </form>
  </span>
</form>
</li>
<%   end %>
</ul>
      </td>
      <!-- RUN -->
      <td class="run">
<% msgs = qc.messages({'state' => 'run'}) %>
<% grouped = {} %>
<% msgs.each do |msg| %>
  <%# BUG -- msg contains -> ["2011...", nil] !!! %>
  <%# so next part is ugly =/ %>
  <% if msg.class == Array %>
    <% msg.each do |m| %>
      <% next if m.nil? %>
      <% date, rest = m.split('.', 2) %>
      <% grouped[date] = [] unless grouped[date] %>
      <% grouped[date] << rest %>
    <% end %>
  <% else %>
    <% date, rest = msg.split('.', 2) %>
    <% grouped[date] = [] unless grouped[date] %>
    <% grouped[date] << rest %>
  <% end %>
<% end %>
<% grouped.sort.reverse.each do |date, msgs| %>
  <h5><%= date %></h5>
  <ul>
  <% msgs.sort.reverse.each do |msg| %>
    <% msg_id = "#{url}q/#{q}/#{msg}" %>
    <li><a href="<%= "#{url}q/#{q}/#{date}.#{msg[0]}" %>"><%= "#{msg[0]}" %></a></li>
    <% if q == 'relay' %>
      <% ok, msg_full = qc.get_message({ 'msg_id' => msg[0]}) %>
      <% if ok == 'ok' %>
        dest: <span class="yellow"> <%= msg_full['dest'] %></span>
        STATUS: <span class="yellow"> <%= msg_full['status'] %></span>
      <% else %>
        STATUS: <span class="yellow"> <%= "#{ok} #{msg_full}" %></span>
      <% end %>
    <% end %>
    <form method="post" action="<%= "#{url}q/#{q}/#{msg[0]}" %>">
      <input name="_method" type="hidden" value="delete" />
      <button type="submit">Destroy it</button>
    </form>
  <% end %>
  </ul>
<% end %>
      </td>
      <% if q != 'relay' %>
      <!-- DONE -->
      <td class="done">
<% msgs = qc.messages({'state' => 'done', 'limit' => 50}) %>
<% grouped = {} %>
<% msgs.each do |msg| %>
  <% date, rest = msg.split('.', 2) %>
  <% grouped[date] = [] unless grouped[date] %>
  <% grouped[date] << rest %>
<% end %>
<% grouped.sort.reverse.each do |date, msgs| %>
  <h5><%= date %></h5>
  <ul>
  <% msgs.sort.reverse.each do |msg| %>
    <% msg_id = "#{url}q/#{q}/#{msg}" %>
    <li><a href="<%= "#{url}q/#{q}/#{date}.#{msg}" %>"><%= msg %></a></li>
  <% end %>
  </ul>
<% end %>
      </td>
    <% end %>
      <!-- ERR -->
      <td class="err">
<% msgs = qc.messages({'state' => 'err'}) %>
<% grouped = {} %>
<% msgs.each do |msg| %>
  <% date, rest = msg.split('.', 2) %>
  <% grouped[date] = [] unless grouped[date] %>
  <% grouped[date] << rest %>
<% end %>
<% grouped.sort.reverse.each do |date, msgs| %>
  <h5><%= date %></h5>
  <ul>
  <% msgs.sort.reverse.each do |msg| %>
    <% msg_id = "#{url}q/#{q}/#{msg}" %>
    <li><a href="<%= "#{url}q/#{q}/#{date}.#{msg}" %>"><%= msg %></a></li>
  <% end %>
  </ul>
<% end %>
      </td>
  </tbody>
</table>

<!-- RELAYED -->
<% if q == 'relay' %>
<div class="relayed">
  <h4><b><%= num_msgs['relayed'] %></b> in RELAYED</h4>
  <% msgs = qc.messages({'state' => 'relayed', 'limit' => 50}) %>
  <% grouped = {} %>
  <% msgs.each do |msg| %>
    <% date, rest = msg.split('.', 2) %>
    <% grouped[date] = [] unless grouped[date] %>
    <% grouped[date] << rest %>
  <% end %>
  <% grouped.sort.reverse.each do |date, msgs| %>
    <h5><%= date %></h5>
    <ul>
    <% msgs.sort.reverse.each do |msg| %>
      <% msg_id = "#{url}q/#{q}/#{msg}" %>
      <li class="relayed-li">
        <a href="<%= "#{url}q/#{q}/#{date}.#{msg}" %>"><%= msg %></a>
        <% ok, msg_full = qc.get_message({ 'msg_id' => date+'.'+msg}) %>
        <% if ok == 'ok' %>
          <%  status, new_location = msg_full['status'].split(' - ', 2) %>
          <!-- <%= status %> -->
          <a title="<%= new_location %>" href="<%= new_location %>"> - <span class="green">relayed</span> - <%= new_location %></a>
        <% end %>
      </li>
    <% end %>
    </ul>
  <% end %>
<% end %>

<h3>config.json (<a href="<%= "#{url}q/#{q}/config.json" %>">raw</a>)</h3>
<% json_path = "queue/#{q}/config.json" %>
<% if File.exists?(json_path) %>
<pre class="json">
<% File.open(json_path) do |file| %>
 <%= file.gets.gsub(/,/, "\n\t").gsub(/\{/, "\t").gsub(/\}/, "").gsub(/\\\//, "/").gsub(/"\:"/, "\" : \"") %>
<% end %>
</pre>
<% else %>
  <p>config.json doesn't currently exist?</p>
<% end %>
